# Recreates Screensaver database and initializes users and roles, w/o
# requiring any database connection arguments from user.
#
# If arg 1 is "dev", connects to development server, otherwise
# connects to production server.

cd ~/ss || exit 1
ant ddl || exit 1

function prompt {
	echo $1
	read prompt
	if [[ "$prompt"	!= "$2" ]]; then
		echo Aborted!
		exit 0;	
	fi
	return 0;
}

# make sure the user is thinking about what they're doing
if [[ -z $1 ]]; then
	RAND=`date +%N`
	prompt "Are you SURE you want to recreate the PRODUCTION Screensaver database? (yes/no)" yes && prompt "Wouldn't you rather do something less destructive? (yes/no)" no && prompt "Okay, fine.  Type '$RAND' to proceed" $RAND
fi

. ss-db-params $1
SQL_FILE=/tmp/ss-recreate-schema.sql
ssh trumpet "cat ~/ss/resources/sql/{drop_schema.sql,create_schema.sql,initialize_database/*.sql} > $SQL_FILE"
echo $PASSWD | ssh trumpet "psql -f $SQL_FILE -U $USER -d $DB -h $HOST -W" || exit 1
