<?xml version="1.0" encoding="UTF-8"?>

<project name="Screensaver" default="deploy" basedir=".">
  <description>
    A build.xml for Screensaver 1.xx
  </description>


	<!-- classpaths -->
    
  <path id="project.classpath">
    <fileset dir="lib">
      <include name="**/*.jar"/>
    </fileset>
  </path>

  <path id="ddl.classpath">
    <path refid="project.classpath"/>
    <pathelement path="resources"/>
  </path>


	<!-- build and deploy -->
  
  <target name="deploy" depends="war">
    <description>
      Deploy Screensaver to the application server.
      Currently unimplemented.
    </description>
  </target>
  
  <target name="war">
    <description>
      Build Screensaver into a Web ARchive.
      Currently unimplemented.
    </description>
  </target>
  
  <target
    name="jar"
    depends="hbm_xml"
    description="Build a Java archive of the class and resource files."
  >
    <javac
      srcdir="src"
      destdir="build/jar"
      classpathref="project.classpath"
    />
    <copy todir="build/jar">
      <fileset dir="resources"/>
    </copy>    
    <jar
      destfile="build/screensaver.jar"
      basedir="build/jar"
    />
  </target>
  
  <target
    name="hbm_xml"
    description="Generate hibernate.cfg.xml and .hbm.xml files"
  >
	  <taskdef
	    name="hibernatedoclet"
	    classname="xdoclet.modules.hibernate.HibernateDocletTask"
	    classpathref="project.classpath"
	  />
    <hibernatedoclet
      destdir="resources"
      excludedtags="@version,@author,@todo"
    >
      <fileset dir="src" casesensitive="yes">
        <include name="edu/harvard/med/screensaver/beans/**/*.java"/>
      </fileset>      
      <hibernatecfg
        version="3.0" 
        showsql="true"
        driver="org.postgresql.Driver"
        jdbcurl="jdbc:postgresql://localhost/screensaver"
        username="screensaver"
        password="screensaver"
        dialect="org.hibernate.dialect.PostgreSQLDialect"
      />
      <hibernate version="3.0" destinationFile="{0}.hbm.xml"/>
    </hibernatedoclet>
  </target>


  <!-- generate ddl -->
	
  <target name="ddl" depends="hbm_xml">
    <description>
      Generate the DDL from the beans classes and associated hbm.xml files
    </description>
    <taskdef
      name="hibernatetool" 
      classname="org.hibernate.tool.ant.HibernateToolTask" 
      classpathref="ddl.classpath"
    />
    <hibernatetool destdir="sql">
      <configuration
   	    configurationfile="resources/hibernate.cfg.xml"
        namingstrategy="org.hibernate.cfg.ImprovedNamingStrategy"
      />
      <hbm2ddl
        export="false"
        format="true"
        outputfilename="create_schema.sql"
      />
      <hbm2ddl
        create="false"
        drop="true"
        export="false"
        format="true"
        outputfilename="drop_schema.sql"
      />
    </hibernatetool>
  </target>

  
  <!-- cleanup routines -->
  
  <target name="clean" description="Clean out generated files.">
    <delete includeemptydirs="true">
      <fileset dir="build/jar" includes="**/*"/>
      <fileset dir="resources" includes="edu/**"/>
      <fileset dir="sql"       includes="create_database.sql"/>
      <fileset dir="sql"       includes="drop_database.sql"/>
      <fileset dir="build"     includes="screensaver.jar"/>
    </delete>
  </target>
  
</project>
