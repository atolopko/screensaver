<?xml version="1.0" encoding="UTF-8"?>
<!--
  $HeadURL$
  $Id$

  Copyright 2006 by the President and Fellows of Harvard College.

  Screensaver is an open-source project developed by the ICCB-L and NSRB labs
  at Harvard Medical School. This software is distributed under the terms of
  the GNU General Public License.
-->

<project
  name="Screensaver"
  default="deploy"
  basedir="."
>
  <description>
    A build.xml for Screensaver 1.xx
  </description>

  <!-- properties -->

  <property 
   name="debug"
   description="controls whether tasks should be 'debug-aware'; provides a short-hand command-line option for setting all *.debug options appropriately"
   value="false"/>
  <property
    name="javac.debug"
    description="controls whether Java compilation generates debug information in class files"
    value="${debug}"/>
  <property
    name="javac.optimize"
    value="true" 
    description="controls whether Java compilation generates debug information in class files"/>
  <condition 
    property="javac.optimize" 
    value="true"
    else="false" >
    <isfalse value="${debug}"/> 
  </condition> 
  <property name="verbose" value="false" description="controls verbosity of various Ant tasks"/> 
  <property name="war" value="build/screensaver.war"/>
  <property name="appserver.dir" value="/usr/local/jakarta-tomcat"/>
  <property name="deploy.dir" value="${appserver.dir}/webapps/screensaver"/>
  <property name="appserver.start.cmd" value="${appserver.dir}/bin/startup.sh"/>
  <property name="appserver.stop.cmd" value="${appserver.dir}/bin/shutdown.sh"/>
  <property name="war.build.dir" location="build/war"/>
  <property name="src.dir" location="src"/>
  <property name="test.src.dir" location="test"/>
  <property name="hibernate.cfg.xml" location="resources/hibernate.cfg.xml"/>
  <property name="javadoc.dir" location="build/api"/>
  <property name="distro.build.dir" location="build/distro/screensaver"/>
  <property name="distro.file.tgz" location="build/screensaver.tgz"/> 
  <property name="distro.file.zip" location="build/screensaver.zip"/> 
 
  <!-- file sets -->

  <fileset
    id="lib.used.fileset"
    dir="lib" 
  >
    <include name="**/*.jar"/>
    <exclude name="**/unused/**"/>
  </fileset>
 
  <fileset
    id="model.src.fileset"
    description="defines the Java source files comprising the application's domain model" 
    dir="${src.dir}"
    casesensitive="yes"
  >
    <include name="edu/harvard/med/screensaver/model/**/*.java"/>
  </fileset>
  
  <fileset 
    id="test.model.src.fileset"
    description="defines the Java source files comprising a domain model for testing purposes; 'test' property must be set"
    dir="${test.src.dir}"
    casesensitive="yes"
  >
    <include 
      if="test"
      name="edu/harvard/med/screensaver/model/Child.java"/>
    <include
      if="test"
      name="edu/harvard/med/screensaver/model/Parent.java"/>
  </fileset>
 
  <fileset
    id="junit.tests.fileset"
    description="defines the Java source files that are JUnit tests" 
    dir="${test.src.dir}"
    casesensitive="yes"
  >
    <include name="edu/harvard/med/screensaver/**/*Test.java"/>
    <exclude name="edu/harvard/med/screensaver/**/Abstract*.java"/>
    <exclude name="edu/harvard/med/screensaver/**/*Suite.java"/>
  </fileset>
 
  <!-- uptodate properties (depends on "file sets" section) -->
 
  <uptodate property="hbm_xml.uptodate" targetfile="${hibernate.cfg.xml}" >
    <srcfiles refid="model.src.fileset"/>
    <srcfiles refid="test.model.src.fileset"/>
  </uptodate> 

  <uptodate property="distro.uptodate" targetfile="${distro.file.tgz}">
    <srcfiles refid="lib.used.fileset"/>
    <srcfiles dir="src"/>
    <srcfiles dir="resources"/>
  </uptodate>
      
  <uptodate property="war.uptodate" targetfile="${war}">
    <srcfiles refid="lib.used.fileset"/>
    <srcfiles dir="src"/>
    <srcfiles dir="resources"/>
    <srcfiles dir="web"/>
    <srcfiles dir="jsp"/>
  </uptodate>
      
  
  <!-- classpaths --> 

  <path id="project.sourcepath" path="${src.dir}"/>

  <path id="project.test.sourcepath" path="${test.src.dir}"/>

  <path id="project.library.path">
    <fileset refid="lib.used.fileset"/>
  </path>

  <path id="distro.project.classpath">
    <path refid="project.library.path"/>
    <pathelement path="${distro.build.dir}/classes"/>
  </path>


  <!-- build and deploy -->
  
  
  <target name="deploy-local">
    <description>
      Deploy Screensaver to a localhost application server, building the exploded WAR deployment directly in its destination directory.
    </description>
    <delete dir="${deploy.dir}"/>
    <antcall target="exploded.war">
      <param name="exploded.war.dir" location="${deploy.dir}"/>
    </antcall>
  </target>

  <target 
    name="deploy-remote"
    depends="war"
  >
    <description>
      Deploy Screensaver to a remote application server.  Builds WAR deployment, then scp's to destination.
    </description>
    <!-- TODO -->
  </target>

  <!-- an alias for deploy-local target -->
  <target name="deploy" depends="deploy-local"/>

  <!-- an alias for deploy-remote target -->
  <target name="release" depends="deploy-remote"/>

  <target 
    name="war"
    unless="war.uptodate"
  >   
    <description>
      Build Screensaver into a Web ARchive (WAR) file
    </description>
    <antcall target="exploded.war">
      <param name="exploded.war.dir" location="${war.build.dir}"/>
    </antcall>
    <jar
      destfile="${war}"
      basedir="${war.build.dir}"
    />
  </target>

  <target
    name="exploded.war"
    depends="hbm_xml"
  >
    <description>
      Generate exploded Web ARchive directory structure for the Screensaver web application.
      Used to 1) create a WAR file, and 2) deploy exploded WAR file to application server.
    </description>
    <property name="webinf.dir" value="${exploded.war.dir}/WEB-INF"/>
    <property name="metainf.dir" value="${exploded.war.dir}/META-INF"/>
    <property name="classes.dir" value="${webinf.dir}/classes"/>

    <mkdir dir="${classes.dir}"/>
  
    <!-- note: javac task clears out ${classes.dir}, so any files we copy there should be done afterwards -->
    <javac 
      srcdir="${src.dir}"
      destdir="${classes.dir}"
      classpathref="project.library.path"
      debug="${javac.debug}" 
      optimize="${javac.optimize}"
      listfiles="${verbose}" 
    />
  
    <copy 
      file="web/manifest.mf" 
      tofile="${metainf.dir}/MANIFEST.MF" 
      verbose="${verbose}"/>

    <!-- if we were to copy jsp files below WEB-INF we have to map each of them in our web.xml file, 
    to allow them to be accessed -->
    <copy 
      todir="${exploded.war.dir}" 
      verbose="${verbose}"
    >
      <fileset dir="jsp" includes="**/*"/>
    </copy>
  
    <copy 
      todir="${webinf.dir}" 
      verbose="${verbose}"
    >
      <!-- we have to copy taglibs directly into the WEB-INF directory, if we want to avoid having
      to provide an explicit mapping for each .tld file in our web.xml <jsp-config> element -->  
      <fileset dir="web/taglib"/>
      <fileset dir="web">
        <include name="web.xml" />
        <include name="faces-config.xml"/> 
       </fileset> 
    </copy>

    <copy 
      todir="${exploded.war.dir}/css"
      verbose="${verbose}"
    >
      <fileset dir="web/css"/>
    </copy>
  
    <copy 
      todir="${exploded.war.dir}/images"
      verbose="${verbose}"
    >
      <fileset dir="web/images"/>
    </copy>

    <!-- deploy log4j.debug.properties as log4j.properties; will be overwritten by normal log4.properties unless 'debug' property is set -->
    <copy
      file="resources/log4j.debug.properties"
      tofile="${classes.dir}/log4j.properties"
      verbose="${verbose}"/>
      
    <copy 
      todir="${classes.dir}" 
      verbose="${verbose}"
    >
      <fileset dir="resources">
        <include name="**/*"/>
        
        <exclude name="log4j.debug.properties"/>
        <excludesfile name="log4j.properties" if="${debug}"/>
      </fileset>    
    </copy>
  
    <copy
      todir="${webinf.dir}/lib"
      flatten="true"
      verbose="${verbose}"      
    >
      <fileset refid="lib.used.fileset"/>
    </copy>
  
  </target>

  <target 
    name="hbm_xml"
    unless="hbm_xml.uptodate"
  >
    <description>
      Generate hibernate.cfg.xml and .hbm.xml files
    </description>
    <taskdef
      name="hibernatedoclet"
      classname="xdoclet.modules.hibernate.HibernateDocletTask"
      classpathref="project.library.path"
    />
    <hibernatedoclet
      destdir="resources"
      excludedtags="@version,@author,@todo"
      verbose="${verbose}"
    >
      <fileset refid="model.src.fileset"/>
      <fileset refid="test.model.src.fileset"/>
      <hibernatecfg
        version="3.0" 
        showsql="true"
        driver="org.postgresql.Driver"
        jdbcurl="jdbc:postgresql://localhost/screensaver"
        username="screensaver"
        password="screensaver"
        dialect="org.hibernate.dialect.PostgreSQLDialect"
      />
      <!-- TODO: make 'hibernate.cfg.xml' property match this destinationFile attribute value -->   
      <hibernate version="3.0" destinationFile="{0}.hbm.xml"/>
    </hibernatedoclet>
  </target>


  <!-- generate ddl -->

  <target 
    name="ddl" 
    depends="hbm_xml"
  >
    <description>
      Generate the DDL from the beans classes and associated hbm.xml files
    </description>
    <taskdef
      name="hibernatetool" 
      classname="org.hibernate.tool.ant.HibernateToolTask" 
      classpathref="project.library.path"
    />
    <hibernatetool destdir="sql">
      <configuration
        configurationfile="resources/hibernate.cfg.xml"
        namingstrategy="org.hibernate.cfg.ImprovedNamingStrategy"
      />
      <hbm2ddl
        export="false"
        format="true"
        outputfilename="create_schema.sql"
      />
      <hbm2ddl
        create="false"
        drop="true"
        export="false"
        format="true"
        outputfilename="drop_schema.sql"
      />
    </hibernatetool>
  </target>
 
  <!-- generate javadoc --> 
 
  <target name="javadoc">
    <javadoc 
     doctitle="Screensaver 1.00" 
     sourcepathref="project.sourcepath"
     classpathref="project.library.path"
     packagenames="edu.harvard.med.screensaver.*" 
     destdir="${javadoc.dir}" 
     access="package" 
     author="true"
     nodeprecated="false"
     nodeprecatedlist="false" 
     noindex="false" 
     nonavbar="false" 
     notree="false"
     splitindex="true" 
     use="true" 
     version="true"
     verbose="${verbose}" 
    />
  </target>


  <!-- Start and stop web application (Tomcat).  (Currently just operates on a localhost Tomcat installation. -->

  <target
    name="start"
    description="Starts the web application on a local Tomcat server"        
    depends="deploy"
  >
    <exec executable="${appserver.start.cmd}"/>
  </target>
 
  <target
    name="stop"
    description="Stops the web application (running locally on a Tomcat server)"
  >
    <exec executable="${appserver.stop.cmd}"><arg line="-force"/></exec>
  </target>

  <target
    name="restart"
    depends="stop,start"
  />

  <!-- run tests -->
 
  <target 
    name="test"
    description="Runs all JUnit tests, after performing a clean build" 
    depends="clean">
    <property name="test" value="true"/>
    <antcall target="war"/>
    <taskdef
      name="junit"
      classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"
      classpathref="project.library.path"
    />

    <junit
      printsummary="true"
      showoutput="true" 
      description="Run all project's tests"
    >
      <test name="edu.harvard.med.screensaver.PackageTestSuite" outfile="test-result"></test> 
    </junit> 
  </target> 
 
  
   <!-- run arbitrary Screensaver class  -->

  <target
   name="run"
   depends="distro"
   description="Run the main method of a class in the Screensaver project."
  >
    <java
      classname="${run.class.name}" 
      fork="true"
      classpathref="distro.project.classpath"
    >
    <arg line="${run.class.args}"/>
   </java> 
  </target>
 
 
   <!-- run the ScreenResultParser --> 
 
  <target
     name="screenresultparser"
     depends="distro"
     description="Run the ScreenResult parser"
    >
    <condition property="wells.to.print.option" value="-wellstoprint ${wells.to.print}" else="">
      <isset property="wells.to.print"/>
    </condition>
    <condition property="ignore.file.paths.option" value="-ignorefilepaths" else="">
      <isset property="ignore.file.paths"/>  
    </condition>
    <java
      classname="edu.harvard.med.screensaver.io.screenresult.ScreenResultParser" 
      fork="true"
      classpathref="distro.project.classpath"
      output="${metadata.file}.out"
      maxmemory="1024m"
    >
      <arg line="-metadatafile ${metadata.file} ${wells.to.print.option} ${ignore.file.paths.option}"/>
    </java>
    <echo message="output written to ${metadata.file}.out"/>
  </target>
  
  
  <!-- schema create/drop operations -->
  
  <target 
    name="schema-recreate"
    depends="distro"
    description="Recreate the schema"
  >
    <property name="db.options" value=""/>
    <java
      classname="edu.harvard.med.screensaver.db.SchemaUtil" 
      fork="true"
      classpathref="distro.project.classpath"
      maxmemory="128m"
    >
      <arg line="--recreate ${db.options}"/>
    </java>
  </target>

 
   <!-- build .tgz and .zip distribution files for command-line applications (main methods) into build/distro -->
 
  <target
    name="distro"
    depends="hbm_xml"
    unless="distro.uptodate"
    description="Build a single-file distribution of the project, so that classes containing Main methods can be executed from the command line"
  >
    <!-- TODO: much of this is duplicating what exploded.war target does, so we should generalize operations -->
    <mkdir dir="${distro.build.dir}/classes"/>
    <javac 
      srcdir="${src.dir}"
      destdir="${distro.build.dir}/classes"
      classpathref="project.library.path"
      debug="${javac.debug}" 
      optimize="${javac.optimize}"
      listfiles="${verbose}" 
    />
    <copy
      todir="${distro.build.dir}/lib"
      flatten="true"
      verbose="${verbose}" 
    >
      <fileset refid="lib.used.fileset"/>
   </copy> 
      <copy 
      todir="${distro.build.dir}/classes" 
      verbose="${verbose}"
    >
      <fileset dir="resources">
        <include name="**/*"/>
        <exclude name="log4j.debug.properties"/>
        <excludesfile name="log4j.properties" if="${debug}"/>
      </fileset>    
    </copy>
    
    <tar
      destfile="${distro.file.tgz}" 
      basedir="${distro.build.dir}/.."
      compression="gzip"
      longfile="gnu" 
    />
    <zip
      destfile="${distro.file.zip}" 
      basedir="${distro.build.dir}/.." 
    /> 
  </target> 
    
   
  <!-- cleanup routines -->

  <target
    name="clean-persistence" 
    description="Clean out generated files related to persistence (Hibernate files, sql schema)."
  >
    <delete includeemptydirs="true">
      <fileset file="${hibernate.cfg.xml}"/>
      <fileset dir="resources" includes="**/*.hbm.xml" />
      <fileset dir="sql" includes="create_schema.sql" />
      <fileset dir="sql" includes="drop_schema.sql" />
      <fileset dir="${javadoc.dir}" includes="**/*"/>   
    </delete>
  </target>

  <target
    name="clean-war"
    description="Clean .war file, and directory structure used to build the .war file"
  >
    <delete
     includeemptydirs="true"
     failonerror="false"
    >
      <fileset dir="build/war"/>
      <fileset file="${war}"/>
    </delete>
  </target>

    <target
      name="clean-distro"
      description="Clean distro file, and directory structure used to build the distro file"
    >
      <delete
       includeemptydirs="true"
       failonerror="false"
      >
        <fileset dir="build/distro/screensaver/classes"/>
        <fileset dir="build/distro/screensaver/lib"/>
        <fileset file="${distro.file.tgz}"/>
        <fileset file="${distro.file.zip}"/>
      </delete>
    </target>
 
  <target 
    name="clean" 
    description="Clean out generated files." 
    depends="clean-persistence,clean-war,clean-distro"
  >
    <delete includeemptydirs="true">
      <fileset dir="resources" includes="edu/**" />
    </delete>
  </target>
  

</project>
