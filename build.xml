<?xml version="1.0" encoding="UTF-8"?>

<project name="Screensaver" default="deploy" basedir=".">
  <description>
    A build.xml for Screensaver 1.xx
  </description>


	<!-- classpath -->
	<!-- TODO: get classpath working properly in hibernate and doclet rules -->
    
  <path id="project.classpath">
    <pathelement path="lib/hibernate-3.1.3/hibernate3.jar"/>
    <pathelement path="lib/hibernate-tools-3.1.0.beta4/hibernate-tools.jar"/>
    <pathelement path="lib/hibernate-tools-3.1.0.beta4/jtidy-r8-21122004.jar"/>
    <pathelement path="lib/hibernate-tools-3.1.0.beta4/velocity-1.4.jar"/>
    <pathelement path="lib/hibernate-tools-3.1.0.beta4/velocity-tools-generic-1.1.jar"/>
    <pathelement path="lib/postgresql-8.1-405.jdbc3.jar"/>
    <pathelement path="build"/>
  </path>


	<!-- build and deploy -->
  
  <target name="deploy" depends="war">
    <description>
      Deploy Screensaver to the application server.
      Currently unimplemented.
    </description>
  </target>
  
  <target name="war">
    <description>
      Build Screensaver into a Web ARchive.
      Currently unimplemented.
    </description>
  </target>
  
  <target name="jar">
    <description>
      Compile the .class files and resources in the build directory into a
      Java ARchive.
    </description>
    <jar destfile="screensaver.jar" basedir="build"/>
  </target>
  
  <target name="build" depends="resources">
    <description>
      Compile the .java files in the src directory into .class files in the
      build directory. Copy the contents of the resources directory into the
      build directory.
    </description>
    <javac srcdir="src" destdir="build" classpathref="project.classpath"/>
    <copy todir="build">
      <fileset dir="resources"/>
    </copy>
  </target>
  
  <target
    name="resources"
    depends="hbm_xml"
    description="Prepare the contents of the resources directory."
  />
  
	<target name="hbm_xml">
		<description>
			Generate .hbm.xml files from Hibernate .java POJOs
		</description>
	  <taskdef
	    name="hibernatedoclet"
	    classname="xdoclet.modules.hibernate.HibernateDocletTask"
	    classpathref="project.classpath"
	  />
    <hibernatedoclet
      destdir="resources"
      force="true"
      excludedtags="@version,@author,@todo"
    >
      <fileset dir="src" casesensitive="yes">
        <include name="edu/harvard/med/screensaver/beans/**/*.java"/>
      </fileset>      
      <hibernatecfg
        version="3.0" 
        showsql="true"
        driver="org.postgresql.Driver"
        jdbcurl="jdbc:postgresql://localhost/screensaver"
        username="screensaver"
        password="screensaver"
        dialect="org.hibernate.dialect.PostgreSQLDialect"
      />
      <hibernate version="3.0" destinationFile="{0}.hbm.xml"/>
    </hibernatedoclet>
	</target>
	
	
	<!-- generate ddl -->
	
  <target name="ddl" depends="hbm_xml">
    <description>
      Generate the DDL from the beans classes and associated hbm.xml files
    </description>
    <taskdef
      name="hibernatetool" 
      classname="org.hibernate.tool.ant.HibernateToolTask" 
      classpathref="project.classpath"
    />
    <hibernatetool destdir="sql">
      <configuration
   	    configurationfile="resources/hibernate.cfg.xml"
        namingstrategy="org.hibernate.cfg.ImprovedNamingStrategy"
      />
      <hbm2ddl
        export="false"
        format="true"
        outputfilename="create_schema.sql"
      />
      <hbm2ddl
        create="false"
        drop="true"
        export="false"
        format="true"
        outputfilename="drop_schema.sql"
      />
    </hibernatetool>
  </target>

  
  <!-- cleanup routines -->
  
  <target name="clean" description="Clean out generated files.">
    <delete includeemptydirs="true">
      <fileset dir="build"     includes="**/*"/>
      <fileset dir="resources" includes="edu/**"/>
      <fileset dir="sql"       includes="create_schema.sql"/>
      <fileset dir="sql"       includes="drop_schema.sql"/>
      <fileset dir="."         includes="screensaver.jar"/>
    </delete>
  </target>
  
</project>
